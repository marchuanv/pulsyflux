# Build Documentation

## Architecture

The Node.js API uses a layered architecture:

```
Node.js (JavaScript)
    ↓
N-API Addon (C++ - addon.cc)
    ↓
Go Shared Library (broker_lib.dll)
    ↓
Broker Package (Go)
```

## Build Process

### 1. Go Shared Library (broker_lib.dll)

**Source:** `broker_lib.go`

**Exports:**
- `ServerNew(address)` - Create server
- `ServerStart(id)` - Start server
- `ServerAddr(id)` - Get server address
- `ServerStop(id)` - Stop server
- `NewClient(address, channelID)` - Create client
- `Publish(id, payload, payloadLen)` - Publish message
- `Subscribe(id, payload, payloadLen)` - Receive message from subscription
- `FreePayload(ptr)` - Free C-allocated memory

**Build Command:**
```bash
cd ..
go build -buildmode=c-shared -o nodejs-api/broker_lib.dll ./nodejs-api/broker_lib.go
cd nodejs-api
```

**Output:**
- `broker_lib.dll` - Shared library
- `broker_lib.h` - C header file

### 2. Import Library (broker_lib.lib)

Windows linker needs an import library to link against the DLL.

**Build Command:**
```bash
zig dlltool -D broker_lib.dll -d broker_lib.def -l broker_lib.lib
```

**Input:** `broker_lib.def` (exports definition)
**Output:** `broker_lib.lib` (import library)

### 3. N-API Addon (broker_addon.node)

**Source:** `addon.cc`

**Classes:**
- `Server` - Wraps Go server functions
  - `start()` - Start server
  - `addr()` - Get address
  - `stop()` - Stop server
- `Client` - Wraps Go client functions
  - `publish(buffer)` - Publish message
  - `subscribe()` - Receive message (returns Buffer or null)

**Build Tool:** zig-build (no Python/CMake required)

**Build Command:**
```javascript
import { build } from 'zig-build';

await build({
  'broker_addon': {
    output: 'build/Release/broker_addon.node',
    sources: ['addon.cc', 'broker_lib.lib'],
    napiVersion: 8
  }
}, {});
```

**Output:** `build/Release/broker_addon.node`

## Package.json Scripts

```json
{
  "scripts": {
    "postinstall": "npm run build",
    "build": "npm run build:go && npm run build:lib && npx tsx build.mjs",
    "build:go": "build.bat",
    "build:lib": "C:\\Users\\Marchuan\\.zig-build\\zig\\0.15.1\\zig.exe dlltool -D broker_lib.dll -d broker_lib.def -l broker_lib.lib",
    "test": "jasmine --config=spec/support/jasmine.json"
  }
}
```

## Dependencies

### Runtime
- `node-addon-api` - N-API C++ wrapper
- `zig-build` - Zero-dependency build tool (downloads Zig automatically)

### Development
- `tsx` - TypeScript runner (runs zig-build TypeScript source)
- `jasmine` - Test framework

## Current Status

### ✅ Working
1. Go shared library builds successfully
2. Import library (.lib) generates successfully
3. zig-build downloads Zig compiler automatically
4. zig-build compiles C++ code
5. Broker API is clean: Server (4 methods), Client (2 methods)

### ❌ Current Issue
Linker error: "lld-link: error: No such file or directory"

The linker command looks correct but fails. Investigating whether:
- Path format issue (forward vs backslashes)
- Missing dependency
- Linker flag issue

### Build Command Output
```
[broker_addon] executing 'zig.exe c++ -o build/Release/broker_addon.node 
  -fPIC -Wl,--as-needed -shared -O2 
  -I[node-api-headers] -I[node-addon-api] 
  -DNAPI_VERSION=8 
  addon.cc broker_lib.lib node.lib'
```

## Files

### Source Files
- `broker_lib.go` - Go C exports
- `addon.cc` - C++ N-API wrapper
- `build.mjs` - zig-build configuration
- `build.bat` - Go build script
- `broker_lib.def` - DLL exports definition

### Generated Files
- `broker_lib.dll` - Go shared library
- `broker_lib.h` - C header (auto-generated by Go)
- `broker_lib.lib` - Import library
- `build/Release/broker_addon.node` - N-API addon (target)

### Configuration
- `package.json` - Build scripts and dependencies
- `tsconfig.json` - TypeScript config (in node_modules/zig-build)

## Installation Flow

1. User runs `npm install`
2. `postinstall` script runs `npm run build`
3. Build process:
   - `build:go` → Creates `broker_lib.dll` and `broker_lib.h`
   - `build:lib` → Creates `broker_lib.lib` from DLL
   - `npx tsx build.mjs` → Compiles `addon.cc` → `broker_addon.node`
4. Node.js loads `broker_addon.node`
5. Addon loads `broker_lib.dll` at runtime

## API Design

The API exactly mirrors the Go broker package:

**Go:**
```go
server := broker.NewServer(":8080")
server.Start()
client, _ := broker.NewClient("localhost:8080", channelID)
client.Publish([]byte("hello"))
ch := client.Subscribe()
msg := <-ch
```

**Node.js:**
```javascript
const server = new Server(':8080');
server.start();
const client = new Client('localhost:8080', channelID);
client.publish(Buffer.from('hello'));
const msg = client.subscribe(); // Returns Buffer or null
```

## Performance Target

- **Current FFI:** 2.3ms latency, 431 ops/sec
- **Target N-API:** 0.5-1ms latency, 5K-10K ops/sec
- **Native Go:** 0.045ms latency, 22K ops/sec

N-API should be 5-10x faster than FFI by eliminating marshaling overhead.
